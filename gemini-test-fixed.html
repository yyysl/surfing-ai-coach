<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="surfing-analyzer.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .debug-log {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .debug-log.info { background: #d1ecf1; color: #0c5460; }
        .debug-log.error { background: #f8d7da; color: #721c24; }
        .debug-log.success { background: #d4edda; color: #155724; }
        .debug-log.warning { background: #fff3cd; color: #856404; }
        
        .test-button {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }
        
        .comparison-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }
        
        .result-panel.success {
            border-left-color: #28a745;
        }
        
        .result-panel.error {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-bug-slash"></i>
                <h1>Gemini API ä¿®å¤æµ‹è¯•</h1>
            </div>
            <p class="subtitle">æµ‹è¯•ä¿®å¤åçš„Gemini APIå“åº”è§£æé—®é¢˜</p>
        </header>

        <main class="main-content">
            <!-- APIé…ç½® -->
            <div class="test-section">
                <h3><i class="fas fa-cog"></i> APIé…ç½®</h3>
                <div style="margin-bottom: 15px;">
                    <label for="apiKeyInput">Gemini API Key:</label>
                    <input type="password" id="apiKeyInput" 
                           value="AIzaSyAMmui41ISIe88sqFmM4D9b2bG9vmBlqo4"
                           style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <button class="test-button" onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
            </div>

            <!-- è°ƒè¯•æ—¥å¿— -->
            <div class="test-section">
                <h3><i class="fas fa-terminal"></i> è°ƒè¯•æ—¥å¿—</h3>
                <div class="debug-panel" id="debugPanel">
                    <div class="debug-log info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                </div>
                <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            </div>

            <!-- å“åº”è§£ææµ‹è¯• -->
            <div class="test-section">
                <h3><i class="fas fa-vial"></i> å“åº”è§£ææµ‹è¯•</h3>
                <p>æµ‹è¯•ä¸åŒæ ¼å¼çš„Geminiå“åº”è§£æ</p>
                
                <div style="margin: 15px 0;">
                    <button class="test-button" onclick="testJsonResponse()">æµ‹è¯•æ ‡å‡†JSONå“åº”</button>
                    <button class="test-button" onclick="testMarkdownResponse()">æµ‹è¯•MarkdownåŒ…è£…å“åº”</button>
                    <button class="test-button" onclick="testMixedResponse()">æµ‹è¯•æ··åˆæ ¼å¼å“åº”</button>
                    <button class="test-button" onclick="testMalformedResponse()">æµ‹è¯•æ ¼å¼é”™è¯¯å“åº”</button>
                </div>

                <div class="comparison-results" id="comparisonResults" style="display: none;">
                    <div class="result-panel">
                        <h4>ä¿®å¤å‰çš„è§£æç»“æœ</h4>
                        <div id="oldResult"></div>
                    </div>
                    <div class="result-panel">
                        <h4>ä¿®å¤åçš„è§£æç»“æœ</h4>
                        <div id="newResult"></div>
                    </div>
                </div>
            </div>

            <!-- å®é™…APIæµ‹è¯• -->
            <div class="test-section">
                <h3><i class="fas fa-robot"></i> å®é™…APIæµ‹è¯•</h3>
                <p>ä½¿ç”¨çœŸå®çš„Gemini APIè¿›è¡Œå†²æµªåˆ†ææµ‹è¯•</p>
                
                <div style="margin: 15px 0;">
                    <input type="file" id="imageInput" accept="image/*" style="margin-bottom: 10px;">
                    <br>
                    <button class="test-button" onclick="testRealGeminiAPI()">æµ‹è¯•çœŸå®Geminiåˆ†æ</button>
                </div>

                <div id="realTestResult" style="margin-top: 15px;"></div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2024 å†²æµªAIæ•™ç»ƒ. Gemini APIä¿®å¤æµ‹è¯•å·¥å…·</p>
        </footer>
    </div>

    <script>
        // è°ƒè¯•å·¥å…·
        const debugPanel = document.getElementById('debugPanel');
        let apiKey = 'AIzaSyAMmui41ISIe88sqFmM4D9b2bG9vmBlqo4';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `debug-log ${type}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            debugPanel.appendChild(logElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            debugPanel.innerHTML = '<div class="debug-log info">æ—¥å¿—å·²æ¸…é™¤</div>';
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                log('è¯·è¾“å…¥API Key', 'error');
                return;
            }

            log('æµ‹è¯•APIè¿æ¥...', 'info');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'æµ‹è¯•è¿æ¥' }] }]
                    })
                });

                if (response.ok) {
                    log('âœ… APIè¿æ¥æˆåŠŸï¼', 'success');
                } else {
                    log(`âŒ APIè¿æ¥å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ—§ç‰ˆæœ¬çš„è§£æå‡½æ•°ï¼ˆæœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼‰
        function parseGeminiResponseOld(responseText) {
            try {
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('æ— æ³•è§£æJSONå“åº”');
                }
            } catch (error) {
                return { error: error.message };
            }
        }

        // æ–°ç‰ˆæœ¬çš„è§£æå‡½æ•°ï¼ˆä¿®å¤åçš„ç‰ˆæœ¬ï¼‰
        function parseGeminiResponseNew(responseText) {
            try {
                // æ¸…ç†æ–‡æœ¬ï¼Œç§»é™¤markdownæ ‡è®°
                let cleanText = responseText.trim();
                
                // ç§»é™¤å„ç§markdownä»£ç å—æ ‡è®°
                if (cleanText.startsWith('```json')) {
                    cleanText = cleanText.substring(7);
                } else if (cleanText.startsWith('```')) {
                    cleanText = cleanText.substring(3);
                }
                if (cleanText.endsWith('```')) {
                    cleanText = cleanText.substring(0, cleanText.length - 3);
                }
                cleanText = cleanText.trim();
                
                // å°è¯•æå–JSONéƒ¨åˆ†
                const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    // å°è¯•ç›´æ¥è§£ææ•´ä¸ªæ–‡æœ¬
                    return JSON.parse(cleanText);
                }
            } catch (error) {
                return { error: error.message };
            }
        }

        // æµ‹è¯•å‡½æ•°
        function runComparisonTest(testData, testName) {
            log(`å¼€å§‹æµ‹è¯•: ${testName}`, 'info');
            
            const oldResult = parseGeminiResponseOld(testData);
            const newResult = parseGeminiResponseNew(testData);
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('comparisonResults').style.display = 'grid';
            document.getElementById('oldResult').innerHTML = `<pre>${JSON.stringify(oldResult, null, 2)}</pre>`;
            document.getElementById('newResult').innerHTML = `<pre>${JSON.stringify(newResult, null, 2)}</pre>`;
            
            // è¯„ä¼°ç»“æœ
            const oldSuccess = !oldResult.error;
            const newSuccess = !newResult.error;
            
            log(`${testName} - ä¿®å¤å‰: ${oldSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, oldSuccess ? 'success' : 'error');
            log(`${testName} - ä¿®å¤å: ${newSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, newSuccess ? 'success' : 'error');
            
            if (!oldSuccess && newSuccess) {
                log(`ğŸ‰ ä¿®å¤ç”Ÿæ•ˆï¼${testName}ç°åœ¨å¯ä»¥æ­£ç¡®è§£æ`, 'success');
            }
        }

        // æµ‹è¯•ä¸åŒæ ¼å¼çš„å“åº”
        function testJsonResponse() {
            const testData = `{
  "surfer_position": "æµªå£",
  "body_posture": "è‰¯å¥½",
  "current_action": "æ»‘è¡Œ",
  "action_quality": "ä¼˜ç§€",
  "timing": "æ—¶æœºæŠŠæ¡å‡†ç¡®",
  "suggestions": ["ä¿æŒå½“å‰å§¿æ€", "å‡†å¤‡ä¸‹ä¸€ä¸ªåŠ¨ä½œ"]
}`;
            runComparisonTest(testData, 'æ ‡å‡†JSONå“åº”');
        }

        function testMarkdownResponse() {
            const testData = `\`\`\`json
{
  "surfer_position": "æµªå³°",
  "body_posture": "éœ€æ”¹è¿›",
  "current_action": "èµ·ä¹˜",
  "action_quality": "è‰¯å¥½",
  "timing": "ç¨å¾®æå‰",
  "suggestions": ["è°ƒæ•´é‡å¿ƒ", "æ§åˆ¶å¹³è¡¡"]
}
\`\`\``;
            runComparisonTest(testData, 'MarkdownåŒ…è£…å“åº”');
        }

        function testMixedResponse() {
            const testData = `æ ¹æ®åˆ†æï¼Œå†²æµªè€…çš„è¡¨ç°å¦‚ä¸‹ï¼š

\`\`\`json
{
  "surfer_position": "æµªåº•",
  "body_posture": "ä¼˜ç§€",
  "current_action": "å›åˆ‡",
  "action_quality": "éœ€æ”¹è¿›",
  "timing": "æ—¶æœºå‡†ç¡®",
  "suggestions": ["åŠ å¤§è½¬å‘è§’åº¦", "æé«˜åŠ¨ä½œæµç•…åº¦"]
}
\`\`\`

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å›åˆ‡åŠ¨ä½œåˆ†æã€‚`;
            runComparisonTest(testData, 'æ··åˆæ ¼å¼å“åº”');
        }

        function testMalformedResponse() {
            const testData = `è¿™é‡Œæ˜¯ä¸€äº›æ–‡å­—æè¿°ï¼Œç„¶åæ˜¯JSONï¼š
{
  "surfer_position": "æµªå£",
  "body_posture": "è‰¯å¥½"
  // æ³¨æ„ï¼šè¿™é‡Œç¼ºå°‘é€—å·
  "current_action": "è½¬å‘"
}
è¿˜æœ‰ä¸€äº›é¢å¤–çš„æ–‡å­—`;
            runComparisonTest(testData, 'æ ¼å¼é”™è¯¯å“åº”');
        }

        // æµ‹è¯•çœŸå®çš„Gemini API
        async function testRealGeminiAPI() {
            const imageInput = document.getElementById('imageInput');
            if (!imageInput.files[0]) {
                log('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'warning');
                return;
            }

            if (!apiKey) {
                log('è¯·å…ˆè®¾ç½®API Key', 'error');
                return;
            }

            log('å¼€å§‹çœŸå®Gemini APIæµ‹è¯•...', 'info');

            try {
                // è½¬æ¢å›¾ç‰‡ä¸ºbase64
                const base64Image = await fileToBase64(imageInput.files[0]);
                
                // æ„å»ºç®€åŒ–çš„æç¤ºè¯
                const prompt = `ä½œä¸ºä¸“ä¸šå†²æµªæ•™ç»ƒï¼Œåˆ†æè¿™å¼ å†²æµªå›¾ç‰‡ä¸­çš„æŠ€æœ¯é—®é¢˜ã€‚

é‡ç‚¹å…³æ³¨ï¼š
1. å†²æµªè€…çš„å§¿æ€å’Œå¹³è¡¡
2. å½“å‰åŠ¨ä½œç±»å‹å’Œæ‰§è¡Œè´¨é‡
3. éœ€è¦æ”¹è¿›çš„æŠ€æœ¯è¦ç‚¹

è¯·è¿”å›ç®€æ´çš„JSONæ ¼å¼åˆ†æï¼š
{
  "surfer_position": "æµªå³°/æµªå£/æµªåº•",
  "body_posture": "ä¼˜ç§€/è‰¯å¥½/éœ€æ”¹è¿›", 
  "current_action": "èµ·ä¹˜/æ»‘è¡Œ/è½¬å‘/å›åˆ‡",
  "action_quality": "ä¼˜ç§€/è‰¯å¥½/éœ€æ”¹è¿›",
  "timing": "æ—¶æœºè¯„ä»·",
  "suggestions": ["å»ºè®®1", "å»ºè®®2"]
}`;

                // è°ƒç”¨Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: "image/jpeg",
                                        data: base64Image.split(',')[1]
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1000
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const rawResponse = data.candidates[0].content.parts[0].text;
                    
                    log('âœ… Gemini APIè°ƒç”¨æˆåŠŸ', 'success');
                    log(`åŸå§‹å“åº”: ${rawResponse}`, 'info');
                    
                    // æµ‹è¯•è§£æ
                    const parsedResult = parseGeminiResponseNew(rawResponse);
                    
                    if (parsedResult.error) {
                        log('âŒ å“åº”è§£æå¤±è´¥', 'error');
                        document.getElementById('realTestResult').innerHTML = `
                            <div class="result-panel error">
                                <h4>è§£æå¤±è´¥</h4>
                                <p>é”™è¯¯: ${parsedResult.error}</p>
                                <h5>åŸå§‹å“åº”:</h5>
                                <pre>${rawResponse}</pre>
                            </div>`;
                    } else {
                        log('âœ… å“åº”è§£ææˆåŠŸ', 'success');
                        document.getElementById('realTestResult').innerHTML = `
                            <div class="result-panel success">
                                <h4>è§£ææˆåŠŸ</h4>
                                <h5>åˆ†æç»“æœ:</h5>
                                <pre>${JSON.stringify(parsedResult, null, 2)}</pre>
                                <h5>åŸå§‹å“åº”:</h5>
                                <pre>${rawResponse}</pre>
                            </div>`;
                    }
                } else {
                    const errorData = await response.json();
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    log(`é”™è¯¯ä¿¡æ¯: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–‡ä»¶è½¬base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            log('Gemini APIä¿®å¤æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('è¯·é€‰æ‹©æµ‹è¯•é¡¹ç›®å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>
