<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API 修复测试</title>
    <link rel="stylesheet" href="surfing-analyzer.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .debug-log {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .debug-log.info { background: #d1ecf1; color: #0c5460; }
        .debug-log.error { background: #f8d7da; color: #721c24; }
        .debug-log.success { background: #d4edda; color: #155724; }
        .debug-log.warning { background: #fff3cd; color: #856404; }
        
        .test-button {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }
        
        .comparison-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }
        
        .result-panel.success {
            border-left-color: #28a745;
        }
        
        .result-panel.error {
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-bug-slash"></i>
                <h1>Gemini API 修复测试</h1>
            </div>
            <p class="subtitle">测试修复后的Gemini API响应解析问题</p>
        </header>

        <main class="main-content">
            <!-- API配置 -->
            <div class="test-section">
                <h3><i class="fas fa-cog"></i> API配置</h3>
                <div style="margin-bottom: 15px;">
                    <label for="apiKeyInput">Gemini API Key:</label>
                    <input type="password" id="apiKeyInput" 
                           value="AIzaSyAMmui41ISIe88sqFmM4D9b2bG9vmBlqo4"
                           style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <button class="test-button" onclick="testApiConnection()">测试API连接</button>
            </div>

            <!-- 调试日志 -->
            <div class="test-section">
                <h3><i class="fas fa-terminal"></i> 调试日志</h3>
                <div class="debug-panel" id="debugPanel">
                    <div class="debug-log info">等待测试开始...</div>
                </div>
                <button class="test-button" onclick="clearLog()">清除日志</button>
            </div>

            <!-- 响应解析测试 -->
            <div class="test-section">
                <h3><i class="fas fa-vial"></i> 响应解析测试</h3>
                <p>测试不同格式的Gemini响应解析</p>
                
                <div style="margin: 15px 0;">
                    <button class="test-button" onclick="testJsonResponse()">测试标准JSON响应</button>
                    <button class="test-button" onclick="testMarkdownResponse()">测试Markdown包装响应</button>
                    <button class="test-button" onclick="testMixedResponse()">测试混合格式响应</button>
                    <button class="test-button" onclick="testMalformedResponse()">测试格式错误响应</button>
                </div>

                <div class="comparison-results" id="comparisonResults" style="display: none;">
                    <div class="result-panel">
                        <h4>修复前的解析结果</h4>
                        <div id="oldResult"></div>
                    </div>
                    <div class="result-panel">
                        <h4>修复后的解析结果</h4>
                        <div id="newResult"></div>
                    </div>
                </div>
            </div>

            <!-- 实际API测试 -->
            <div class="test-section">
                <h3><i class="fas fa-robot"></i> 实际API测试</h3>
                <p>使用真实的Gemini API进行冲浪分析测试</p>
                
                <div style="margin: 15px 0;">
                    <input type="file" id="imageInput" accept="image/*" style="margin-bottom: 10px;">
                    <br>
                    <button class="test-button" onclick="testRealGeminiAPI()">测试真实Gemini分析</button>
                </div>

                <div id="realTestResult" style="margin-top: 15px;"></div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2024 冲浪AI教练. Gemini API修复测试工具</p>
        </footer>
    </div>

    <script>
        // 调试工具
        const debugPanel = document.getElementById('debugPanel');
        let apiKey = 'AIzaSyAMmui41ISIe88sqFmM4D9b2bG9vmBlqo4';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `debug-log ${type}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            debugPanel.appendChild(logElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            debugPanel.innerHTML = '<div class="debug-log info">日志已清除</div>';
        }

        // 测试API连接
        async function testApiConnection() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                log('请输入API Key', 'error');
                return;
            }

            log('测试API连接...', 'info');
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: '测试连接' }] }]
                    })
                });

                if (response.ok) {
                    log('✅ API连接成功！', 'success');
                } else {
                    log(`❌ API连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 连接错误: ${error.message}`, 'error');
            }
        }

        // 旧版本的解析函数（有问题的版本）
        function parseGeminiResponseOld(responseText) {
            try {
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error('无法解析JSON响应');
                }
            } catch (error) {
                return { error: error.message };
            }
        }

        // 新版本的解析函数（修复后的版本）
        function parseGeminiResponseNew(responseText) {
            try {
                // 清理文本，移除markdown标记
                let cleanText = responseText.trim();
                
                // 移除各种markdown代码块标记
                if (cleanText.startsWith('```json')) {
                    cleanText = cleanText.substring(7);
                } else if (cleanText.startsWith('```')) {
                    cleanText = cleanText.substring(3);
                }
                if (cleanText.endsWith('```')) {
                    cleanText = cleanText.substring(0, cleanText.length - 3);
                }
                cleanText = cleanText.trim();
                
                // 尝试提取JSON部分
                const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    // 尝试直接解析整个文本
                    return JSON.parse(cleanText);
                }
            } catch (error) {
                return { error: error.message };
            }
        }

        // 测试函数
        function runComparisonTest(testData, testName) {
            log(`开始测试: ${testName}`, 'info');
            
            const oldResult = parseGeminiResponseOld(testData);
            const newResult = parseGeminiResponseNew(testData);
            
            // 显示结果
            document.getElementById('comparisonResults').style.display = 'grid';
            document.getElementById('oldResult').innerHTML = `<pre>${JSON.stringify(oldResult, null, 2)}</pre>`;
            document.getElementById('newResult').innerHTML = `<pre>${JSON.stringify(newResult, null, 2)}</pre>`;
            
            // 评估结果
            const oldSuccess = !oldResult.error;
            const newSuccess = !newResult.error;
            
            log(`${testName} - 修复前: ${oldSuccess ? '✅ 成功' : '❌ 失败'}`, oldSuccess ? 'success' : 'error');
            log(`${testName} - 修复后: ${newSuccess ? '✅ 成功' : '❌ 失败'}`, newSuccess ? 'success' : 'error');
            
            if (!oldSuccess && newSuccess) {
                log(`🎉 修复生效！${testName}现在可以正确解析`, 'success');
            }
        }

        // 测试不同格式的响应
        function testJsonResponse() {
            const testData = `{
  "surfer_position": "浪壁",
  "body_posture": "良好",
  "current_action": "滑行",
  "action_quality": "优秀",
  "timing": "时机把握准确",
  "suggestions": ["保持当前姿态", "准备下一个动作"]
}`;
            runComparisonTest(testData, '标准JSON响应');
        }

        function testMarkdownResponse() {
            const testData = `\`\`\`json
{
  "surfer_position": "浪峰",
  "body_posture": "需改进",
  "current_action": "起乘",
  "action_quality": "良好",
  "timing": "稍微提前",
  "suggestions": ["调整重心", "控制平衡"]
}
\`\`\``;
            runComparisonTest(testData, 'Markdown包装响应');
        }

        function testMixedResponse() {
            const testData = `根据分析，冲浪者的表现如下：

\`\`\`json
{
  "surfer_position": "浪底",
  "body_posture": "优秀",
  "current_action": "回切",
  "action_quality": "需改进",
  "timing": "时机准确",
  "suggestions": ["加大转向角度", "提高动作流畅度"]
}
\`\`\`

这是一个典型的回切动作分析。`;
            runComparisonTest(testData, '混合格式响应');
        }

        function testMalformedResponse() {
            const testData = `这里是一些文字描述，然后是JSON：
{
  "surfer_position": "浪壁",
  "body_posture": "良好"
  // 注意：这里缺少逗号
  "current_action": "转向"
}
还有一些额外的文字`;
            runComparisonTest(testData, '格式错误响应');
        }

        // 测试真实的Gemini API
        async function testRealGeminiAPI() {
            const imageInput = document.getElementById('imageInput');
            if (!imageInput.files[0]) {
                log('请先选择一张图片', 'warning');
                return;
            }

            if (!apiKey) {
                log('请先设置API Key', 'error');
                return;
            }

            log('开始真实Gemini API测试...', 'info');

            try {
                // 转换图片为base64
                const base64Image = await fileToBase64(imageInput.files[0]);
                
                // 构建简化的提示词
                const prompt = `作为专业冲浪教练，分析这张冲浪图片中的技术问题。

重点关注：
1. 冲浪者的姿态和平衡
2. 当前动作类型和执行质量
3. 需要改进的技术要点

请返回简洁的JSON格式分析：
{
  "surfer_position": "浪峰/浪壁/浪底",
  "body_posture": "优秀/良好/需改进", 
  "current_action": "起乘/滑行/转向/回切",
  "action_quality": "优秀/良好/需改进",
  "timing": "时机评价",
  "suggestions": ["建议1", "建议2"]
}`;

                // 调用Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: "image/jpeg",
                                        data: base64Image.split(',')[1]
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 1000
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const rawResponse = data.candidates[0].content.parts[0].text;
                    
                    log('✅ Gemini API调用成功', 'success');
                    log(`原始响应: ${rawResponse}`, 'info');
                    
                    // 测试解析
                    const parsedResult = parseGeminiResponseNew(rawResponse);
                    
                    if (parsedResult.error) {
                        log('❌ 响应解析失败', 'error');
                        document.getElementById('realTestResult').innerHTML = `
                            <div class="result-panel error">
                                <h4>解析失败</h4>
                                <p>错误: ${parsedResult.error}</p>
                                <h5>原始响应:</h5>
                                <pre>${rawResponse}</pre>
                            </div>`;
                    } else {
                        log('✅ 响应解析成功', 'success');
                        document.getElementById('realTestResult').innerHTML = `
                            <div class="result-panel success">
                                <h4>解析成功</h4>
                                <h5>分析结果:</h5>
                                <pre>${JSON.stringify(parsedResult, null, 2)}</pre>
                                <h5>原始响应:</h5>
                                <pre>${rawResponse}</pre>
                            </div>`;
                    }
                } else {
                    const errorData = await response.json();
                    log(`❌ API调用失败: ${response.status}`, 'error');
                    log(`错误信息: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
            }
        }

        // 文件转base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', () => {
            log('Gemini API修复测试工具已加载', 'success');
            log('请选择测试项目开始测试', 'info');
        });
    </script>
</body>
</html>
